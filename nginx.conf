events {}

http {
    # Configuration du prerender
    map $http_user_agent $prerender_ua {
        default       0;
        "~*Prerender" 0;

        "~*(googlebot|bingbot|yandex|baiduspider|facebookexternalhit|twitterbot|rogerbot|linkedinbot|embedly|quora|showyoubot|outbrain|pinterest|slackbot|vkshare|w3c_validator|redditbot|applebot|whatsapp|flipboard|tumblr|bitlybot|skypeuripreview|nuzzel|discordbot|qwantify|petalbot|Outiref|OutirefBot|Outiref bot|Outiref-Bot|Outiref Crawler|Outiref-Spider|Outiref-WebCrawler|Outiref-Scanner|Outiref-Indexer|Outiref-Explorer|Outiref-Search|Outiref-API|Outiref-DataFetcher|Outiref-DataCollector|Outiref-DataScraper|Outiref-DataHarvester|Outiref-DataMiner|Outiref-DataExtractor|Outiref-DataAnalyzer|Outiref-DataProcessor|Outiref-DataAggregator|Outiref-DataFetcherBot|Outiref-DataCollectorBot|Outiref-DataScraperBot|Outiref-DataHarvesterBot|Outiref-DataMinerBot|Outiref-DataExtractorBot|Outiref-DataAnalyzerBot|Outiref-DataProcessorBot|Outiref-DataAggregatorBot)" 1;
    }

    map $args $prerender_args {
        default $prerender_ua;
        "~(^|&)_escaped_fragment_=" 1;
    }

    map $http_x_prerender $x_prerender {
        default $prerender_args;
        "1"     0;
    }

    map $uri $prerender {
        default $x_prerender;
        "~*\.(js|css|xml|less|png|jpg|jpeg|gif|pdf|txt|ico|rss|zip|mp3|rar|exe|wmv|doc|avi|ppt|mpg|mpeg|tif|wav|mov|psd|ai|xls|mp4|m4a|swf|dat|dmg|iso|flv|m4v|torrent|ttf|woff|woff2|svg|eot)" 0;
    }

    server {
        listen 80;
        server_name dsp-archiwebf22-yy-om.site www.dsp-archiwebf22-yy-om.site;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl;
        server_name dsp-archiwebf22-yy-om.site www.dsp-archiwebf22-yy-om.site;

        ssl_certificate /etc/letsencrypt/live/dsp-archiwebf22-yy-om.site/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/dsp-archiwebf22-yy-om.site/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # Gestion des assets statiques
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            proxy_pass http://pfe-frontend:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        location / {
            if ($prerender = 1) {
                rewrite ^(.*)$ /prerenderio$1 break;
            }

            proxy_pass http://pfe-frontend:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_method $request_method;
            proxy_pass_request_headers on;
        }

        location /prerenderio {
            if ($prerender = 0) {
                return 404;
            }

            proxy_set_header X-Prerender-Token XifyXRMXuF5XsCrGbyvC;
            proxy_set_header X-Prerender-Int-Type Nginx_Rev_Proxy;
            proxy_hide_header Cache-Control;
            add_header Cache-Control "private,max-age=600,must-revalidate";
            resolver 8.8.8.8 8.8.4.4;
            set $prerender_host "service.prerender.io";
            proxy_pass https://$prerender_host;
            rewrite .* /$scheme://$host$request_uri? break;
        }

        location ~* ^/(users|ticketApi) {
            proxy_pass http://pfe-backend:5001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}